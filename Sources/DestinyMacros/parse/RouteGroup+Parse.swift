
import DestinyBlueprint
import DestinyDefaults
import SwiftSyntax
import SwiftSyntaxMacros

extension RouteGroup {
    /// Parsing logic for this router group.
    /// 
    /// - Parameters:
    ///   - context: The macro expansion context.
    ///   - version: The `HTTPVersion` of the router this router group belongs to.
    ///   - staticMiddleware: The static middleware of the router this router group belongs to.
    ///   - dynamicMiddleware: The dynamic middleware of the router this router group belongs to.
    ///   - function: SwiftSyntax expression that represents this router group at compile time.
    public static func parse(
        context: some MacroExpansionContext,
        visibility: RouterVisibility,
        perfectHashSettings: PerfectHashSettings,
        version: HTTPVersion,
        staticMiddleware: [CompiledStaticMiddleware],
        dynamicMiddleware: [FunctionCallExprSyntax],
        storage: inout RouterStorage,
        _ function: FunctionCallExprSyntax
    ) -> (decl: DeclSyntax, storage: RouterStorage) {
        var routeGroupStorage = RouterStorage(visibility: visibility, perfectHashSettings: perfectHashSettings)
        routeGroupStorage.autoGeneratedCaseSensitiveRespondersIndex = storage.autoGeneratedCaseSensitiveRespondersIndex
        routeGroupStorage.autoGeneratedCaseInsensitiveRespondersIndex = storage.autoGeneratedCaseInsensitiveRespondersIndex
        routeGroupStorage.autoGeneratedDynamicRespondersIndex = storage.autoGeneratedDynamicRespondersIndex
        routeGroupStorage.staticMiddleware = staticMiddleware

        var endpoint = ""
        var conditionalResponders = [SIMD64<UInt8>:any ConditionalRouteResponderProtocol]()
        for f in dynamicMiddleware {
            Router.parseDynamicMiddleware(context: context, function: f, storage: &routeGroupStorage)
        }
        
        for arg in function.arguments {
            if let label = arg.label?.text {
                switch label {
                case "endpoint":
                    guard let string = arg.expression.stringLiteralString(context: context) else { break }
                    endpoint = string
                case "staticMiddleware":
                    guard let array = arg.expression.arrayElements(context: context) else { break }
                    for arg in array {
                        if let function = arg.expression.functionCall {
                            Router.parseStaticMiddleware(context: context, function: function, storage: &routeGroupStorage)
                        }
                    }
                case "dynamicMiddleware":
                    guard let array = arg.expression.arrayElements(context: context) else { break }
                    for arg in array {
                        if let function = arg.expression.functionCall {
                            Router.parseDynamicMiddleware(context: context, function: function, storage: &routeGroupStorage)
                        }
                    }
                default:
                    context.diagnose(DiagnosticMsg.unhandled(node: arg))
                }
            } else if let function = arg.expression.functionCall {
                Router.parseRoute(context: context, version: version, function: function, storage: &routeGroupStorage)
            }
        }

        let prefixEndpoints = endpoint.split(separator: "/").map({ String($0) })
        let pathComponents = prefixEndpoints.map({ PathComponent.literal($0) })

        let dynamicMiddlewareString = routeGroupStorage.dynamicMiddleware.map({ "\($0)" }).joined(separator: ",\n")

        let immutableDynamicMiddlewareSyntax:String
        if routeGroupStorage.dynamicMiddleware.isEmpty {
            immutableDynamicMiddlewareSyntax = "Optional<CompiledDynamicMiddlewareStorage<DynamicMiddleware>>.none"
        } else {
            immutableDynamicMiddlewareSyntax = "CompiledDynamicMiddlewareStorage((\n\(dynamicMiddlewareString)\n))"
        }

        for i in routeGroupStorage.staticRoutes.indices {
            var (route, function) = routeGroupStorage.staticRoutes[i]
            route.insertPath(contentsOf: prefixEndpoints, at: 0)
            routeGroupStorage.staticRoutes[i] = (route, function)
        }
        let staticRespondersSyntax = routeGroupStorage.staticRoutesSyntax(
            mutable: false,
            context: context,
            isCaseSensitive: true,
            redirects: routeGroupStorage.staticRedirects,
            middleware: routeGroupStorage.staticMiddleware,
            routes: routeGroupStorage.staticRoutes
        )

        for i in routeGroupStorage.dynamicRoutes.indices {
            var (route, function) = routeGroupStorage.dynamicRoutes[i]
            route.insertPath(contentsOf: pathComponents, at: 0)
            routeGroupStorage.dynamicRoutes[i] = (route, function)
        }
        let dynamicRespondersSyntax = routeGroupStorage.dynamicRoutesSyntax(
            mutable: false,
            context: context,
            isCaseSensitive: true,
            routes: routeGroupStorage.dynamicRoutes
        )

        let compiled = """
        CompiledRouteGroup(
            prefixEndpoints: \(prefixEndpoints),
            immutableDynamicMiddleware: \(immutableDynamicMiddlewareSyntax),
            immutableStaticResponders: \(staticRespondersSyntax),
            immutableDynamicResponders: \(dynamicRespondersSyntax),
            mutableStaticResponders: CaseSensitiveStaticResponderStorage(),
            mutableDynamicResponders: DynamicResponderStorage()
        )
        """

        storage.autoGeneratedCaseSensitiveRespondersIndex = routeGroupStorage.autoGeneratedCaseSensitiveRespondersIndex
        storage.autoGeneratedCaseInsensitiveRespondersIndex = routeGroupStorage.autoGeneratedCaseInsensitiveRespondersIndex
        storage.autoGeneratedDynamicRespondersIndex = routeGroupStorage.autoGeneratedDynamicRespondersIndex
        return (DeclSyntax(stringLiteral: compiled), routeGroupStorage)
    }
}